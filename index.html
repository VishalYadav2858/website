<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SOS Link ‚Äî Enhanced</title>
<meta name="theme-color" content="#b71c1c"/>

<style>
/* ==========  COLOURS  ========== */
:root{
  --bg:#0f172a;          /* slate-900  */
  --panel:#111827ee;     /* gray-900   */
  --muted:#94a3b8;       /* slate-400  */
  --text:#e5e7eb;        /* gray-200   */
  --brand:#ef4444;       /* red-500    */
  --brand-dark:#b91c1c;  /* red-700    */
  --accent:#2563eb;      /* blue-600   */
  --ok:#22c55e;          /* green-500  */
  --warn:#f59e0b;        /* amber-500  */
  --card:#0b1226;        /* deep       */
  --ring:0 0 0 2px rgba(37,99,235,.35);
  --critical:#dc2626;    /* red-600    */
  --high:#ea580c;        /* orange-600 */
  --medium:#ca8a04;      /* yellow-600 */
  --low:#16a34a;         /* green-600  */
  --minimal:#2563eb;     /* blue-600   */
}
/* ==========  RESET  ========== */
*{box-sizing:border-box;margin:0}
html,body{height:100%}
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  background:
    radial-gradient(1200px 600px at 10% -10%,#1f2937,transparent),
    radial-gradient(900px 600px at 110% 10%,#111827,transparent),
    var(--bg);
  color:var(--text);
}

/* ==========  HEADER  ========== */
header{
  position:sticky;top:0;z-index:5;
  backdrop-filter:saturate(140%) blur(8px);
  background:linear-gradient(0deg,#111827d9,#111827f7);
  border-bottom:1px solid #1f2937;
  padding:14px 18px;
  display:flex;align-items:center;justify-content:space-between;gap:14px
}
.brand{display:flex;align-items:center;gap:10px}
.brand .logo{
  width:42px;height:42px;
  display:grid;place-items:center;
  border-radius:12px;
  background:linear-gradient(135deg,var(--brand),var(--brand-dark));
  box-shadow:0 10px 24px rgba(239,68,68,.35)
}
h1{font-size:20px}
.tag{font-size:12px;color:var(--muted)}
nav{display:flex;gap:8px}
button.tab{
  border:1px solid #1f2937;background:#0b1226;color:#cbd5e1;
  padding:10px 14px;border-radius:12px;cursor:pointer
}
button.tab.active{
  background:linear-gradient(135deg,#0f172a,#0b1226);
  border-color:#334155;box-shadow:var(--ring)
}

/* ==========  CONNECTION STATUS  ========== */
.connection-status{
  position:fixed;top:20px;right:20px;z-index:10;
  padding:8px 12px;border-radius:8px;font-size:12px;
  transition:all 0.3s ease;
}
.connection-status.online{background:var(--ok);color:white;}
.connection-status.offline{background:var(--critical);color:white;}
.connection-status.syncing{background:var(--warn);color:white;}

/* ==========  MAIN LAYOUT  ========== */
main{
  width:100%;padding:22px 10px;
  display:flex;flex-direction:column;align-items:center
}
.grid{
  width:100%;
  max-width:1300px;               /* pleasant limit on ultra-wide screens   */
  display:flex;flex-direction:column;gap:24px;
}

/* ==========  CARD  ========== */
.card{
  width:100%;
  background:linear-gradient(180deg,#0b1226ee,#0b1226f6);
  border:1px solid #1f2937;border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
  padding:22px
}
.card h2{font-size:18px;margin-bottom:10px}
.sub{color:#a5b4fc;font-size:12px}

/* ==========  FORM & INPUTS  ========== */
.form{display:grid;gap:14px}
.row{display:grid;gap:12px}
@media(min-width:640px){.row{grid-template-columns:1fr 1fr}}
@media(min-width:768px){.row.three{grid-template-columns:1fr 1fr 1fr}}
input,textarea{
  background:#0b1226;color:#e5e7eb;
  border:1px solid #243041;border-radius:12px;
  padding:12px;outline:none;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  font-size:14px;
}
input:focus,textarea:focus{box-shadow:var(--ring);border-color:#334155}
textarea{min-height:110px;resize:vertical}

.actions{display:flex;gap:10px;flex-wrap:wrap}
.btn{
  border:1px solid #243041;background:#0b1226;color:#e5e7eb;
  padding:10px 14px;border-radius:12px;cursor:pointer;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  font-size:14px;
}
.btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-dark));border-color:transparent}
.btn.ok{background:linear-gradient(135deg,#16a34a,#15803d);border-color:transparent}
.btn.warn{background:linear-gradient(135deg,#f59e0b,#d97706);border-color:transparent}
.btn.ghost{background:transparent}
.btn.danger{background:linear-gradient(135deg,#dc2626,#b91c1c);border-color:transparent}

.muted{color:var(--muted)}

/* ==========  KPI  ========== */
.kpis{display:flex;gap:10px;flex-wrap:wrap}
.kpi{
  flex:1 1 140px;background:#0b1226;border:1px solid #1f2937;
  border-radius:14px;padding:12px
}
.kpi .n{font-size:22px;font-weight:700}.kpi .l{font-size:12px;color:var(--muted)}

/* ==========  LISTS  ========== */
.split{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.split>div{display:flex;flex-direction:column}
.list{flex:1 1 auto;display:grid;gap:10px;min-height:220px}
.item{
  background:linear-gradient(180deg,#0f172a,#0b1226);
  border:1px solid #1f2937;border-radius:14px;padding:12px;
  position:relative;
}
.item.critical{border-color:var(--critical);border-width:2px;}
.item.high{border-color:var(--high);border-width:2px;}
.item.medium{border-color:var(--medium);}
.item.low{border-color:var(--low);}
.item.minimal{border-color:var(--minimal);}
.item.spam{border-color:#6b7280;opacity:0.7;border-style:dashed;}

.meta{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:#cbd5e1}
.badge{padding:3px 8px;border-radius:999px;border:1px solid #334155;background:#0b1226}
.badge.ok{border-color:#166534;color:#86efac}
.badge.warn{border-color:#92400e;color:#fcd34d}
.badge.pending{border-color:#334155;color:#93c5fd}

.badge.critical{border-color:var(--critical);color:#fca5a5;background:rgba(220,38,38,.1)}
.badge.high{border-color:var(--high);color:#fdba74;background:rgba(234,88,12,.1)}
.badge.medium{border-color:var(--medium);color:#fde047;background:rgba(202,138,4,.1)}
.badge.low{border-color:var(--low);color:#86efac;background:rgba(22,163,74,.1)}
.badge.minimal{border-color:var(--minimal);color:#93c5fd;background:rgba(37,99,235,.1)}
.badge.spam{border-color:#6b7280;color:#d1d5db;background:rgba(107,114,128,.1)}

.badge.medical{border-color:#dc2626;color:#fca5a5;background:rgba(220,38,38,.1)}
.badge.food{border-color:#16a34a;color:#86efac;background:rgba(22,163,74,.1)}
.badge.shelter{border-color:#2563eb;color:#93c5fd;background:rgba(37,99,235,.1)}
.badge.trapped{border-color:#ea580c;color:#fdba74;background:rgba(234,88,12,.1)}
.badge.other{border-color:#6b7280;color:#d1d5db;background:rgba(107,114,128,.1)}

.priority-indicator{
  position:absolute;top:12px;right:12px;
  width:8px;height:8px;border-radius:50%;
}
.priority-indicator.critical{background:var(--critical);}
.priority-indicator.high{background:var(--high);}
.priority-indicator.medium{background:var(--medium);}
.priority-indicator.low{background:var(--low);}
.priority-indicator.minimal{background:var(--minimal);}

.maplink{font-size:12px}
.empty{color:var(--muted);text-align:center;padding:18px}

/* ==========  AI REASONING  ========== */
.ai-reasoning{
  background:rgba(37,99,235,.1);
  border:1px solid #2563eb;
  border-radius:8px;
  padding:8px 10px;
  margin:8px 0;
  font-size:11px;
  color:#93c5fd;
}
.ai-reasoning strong{color:#ddd6fe}

/* ==========  QUEUE STATUS  ========== */
.queue-status{
  margin:10px 0;padding:10px;border-radius:8px;
  background:rgba(234,88,12,.1);border:1px solid #ea580c;
  font-size:12px;color:#fdba74;
}

/* ==========  FOOTER  ========== */
footer{padding:18px;text-align:center;color:#94a3b8}
</style>
</head>

<body>
<div id="connectionStatus" class="connection-status online">üü¢ Online</div>

<header>
  <div class="brand">
    <div class="logo">üö®</div>
    <div>
      <h1>SOS Link</h1>
      <div class="tag">AI-Powered Emergency Response ‚Ä¢ Offline-First</div>
    </div>
  </div>

  <nav>
    <button class="tab active" data-tab="victim">Victim Portal</button>
    <button class="tab" data-tab="rescuer">Rescuer Portal</button>
  </nav>
</header>

<main>
  <div class="grid">

    <!-- =================  VICTIM  ================= -->
    <section id="victim" class="card">
      <h2>Victim Portal</h2>
      <div class="sub">All fields are required. Works offline - requests will be sent when connection returns.</div>

      <div id="queueStatus" class="queue-status" style="display:none;">
        <strong>üì° Connection lost:</strong> Your request will be queued and sent automatically when connection returns.
      </div>

      <form id="sosForm" class="form" autocomplete="off" novalidate>
        <div class="row three">
          <input id="name" placeholder="Your name" required />
          <input id="age" type="number" inputmode="numeric" placeholder="Age" required min="1" max="120" />
          <input id="phone" inputmode="tel" placeholder="10-digit phone" required
                 pattern="\\d{10}" minlength="10" maxlength="10" />
        </div>

        <textarea id="message" placeholder="Describe your emergency‚Ä¶ (be specific: injuries, children, elderly, etc.)" required></textarea>

        <input id="coords" placeholder="Lat, Long (auto)" readonly required />

        <div class="actions">
          <button type="button" class="btn" id="detectBtn">üìç Detect Location</button>
          <button type="submit" class="btn primary">Send SOS</button>
          <button type="button" class="btn ghost" id="clearForm">Clear</button>
        </div>
        <div id="locStatus" class="muted"></div>
      </form>
    </section>

    <!-- =================  RESCUER  ================= -->
    <section id="rescuer" class="card" hidden>
      <h2>Rescuer Portal</h2>

      <div class="kpis">
        <div class="kpi"><div class="n" id="kpiTotal">0</div><div class="l">Total Requests</div></div>
        <div class="kpi"><div class="n" id="kpiPending">0</div><div class="l">Pending</div></div>
        <div class="kpi"><div class="n" id="kpiResolved">0</div><div class="l">Resolved</div></div>
        <div class="kpi"><div class="n" id="kpiCritical">0</div><div class="l">Critical</div></div>
      </div>

      <div class="searchbar" style="display:flex;gap:10px;margin:10px 0;flex-wrap:wrap">
        <input id="search" placeholder="Search by name, location or text‚Ä¶"/>
        <button class="btn" id="resetSearch">Reset</button>
        <button class="btn danger" id="clearAll">üóëÔ∏è Clear All</button>
        <select id="categoryFilter" class="btn" style="background:#0b1226;border:1px solid #243041">
          <option value="">All Categories</option>
          <option value="medical">üè• Medical</option>
          <option value="food">üçû Food</option>
          <option value="shelter">üè† Shelter</option>
          <option value="trapped">üöß Trapped</option>
          <option value="other">‚ùì Other</option>
        </select>
        <select id="priorityFilter" class="btn" style="background:#0b1226;border:1px solid #243041">
          <option value="">All Priorities</option>
          <option value="critical">üî¥ Critical</option>
          <option value="high">üü† High</option>
          <option value="medium">üü° Medium</option>
          <option value="low">üü¢ Low</option>
          <option value="minimal">üîµ Minimal</option>
        </select>
        <select id="spamFilter" class="btn" style="background:#0b1226;border:1px solid #243041">
          <option value="hide">Hide Spam</option>
          <option value="show">Show All</option>
          <option value="only">Spam Only</option>
        </select>
      </div>

      <div class="split">
        <div>
          <h3 style="margin:6px 0 10px">Pending Requests <span style="color:var(--muted);font-size:12px;">(Agentic AI ‚Äì Sorted by Priority)</span></h3>
          <div id="pendingList" class="list"></div>
        </div>

        <div>
          <h3 style="margin:6px 0 10px">Resolved Requests</h3>
          <div id="resolvedList" class="list"></div>
        </div>
      </div>
    </section>

  </div>
</main>

<footer>
  <small>SOS Requests will be ranked by Agentic AI on factors such as Age, Severity, and Immediacy, with auto-categorization and offline resilience. Works on 2G/3G networks.</small>
</footer>

<script>
/* =======  LOCAL-STORAGE HELPERS  ======= */
const KEY = 'sos.requests.v5';
const QUEUE_KEY = 'sos.queue.v5';
const SYNC_KEY = 'sos.sync.v5';
const load = () => JSON.parse(localStorage.getItem(KEY)||'[]');
const save = arr => localStorage.setItem(KEY,JSON.stringify(arr));
const loadQueue = () => JSON.parse(localStorage.getItem(QUEUE_KEY)||'[]');
const saveQueue = arr => localStorage.setItem(QUEUE_KEY,JSON.stringify(arr));

let sosRequests = load();
let requestQueue = loadQueue();
let lastSyncTime = localStorage.getItem(SYNC_KEY) || '0';

/* =======  AGENTIC AI PRIORITIZATION SYSTEM  ======= */
const SEVERITY_KEYWORDS = {
  high: ['bleeding', 'blood', 'unconscious', 'not breathing', 'heart attack', 'stroke', 'overdose', 'severe pain', 'dying', 'death', 'critical', 'emergency', 'urgent', 'brain damage', 'broken bone', 'fracture', 'accident', 'fire', 'explosion'],
  medium: ['pain', 'injury', 'hurt', 'sick', 'fever', 'medical', 'help', 'assistance', 'trapped', 'stuck'],
  low: ['minor', 'small', 'question', 'information', 'lost', 'stranded']
};

const IMMEDIACY_KEYWORDS = {
  critical: ['now', 'immediately', 'urgent', 'emergency', 'dying', 'critical', 'can\'t breathe', 'heart attack', 'stroke'],
  moderate: ['soon', 'help', 'need', 'assistance', 'pain', 'hurt'],
  low: ['later', 'when possible', 'information', 'question']
};

const VULNERABILITY_KEYWORDS = {
  high: ['child', 'children', 'baby', 'infant', 'elderly', 'old', 'disabled', 'pregnant', 'wheelchair'],
  medium: ['adult', 'person'],
  low: ['minor concern', 'small issue']
};

const SPAM_KEYWORDS = ['test', 'testing', 'hello', 'hi', 'fake', 'joke', 'lol', 'haha', 'spam', 'ignore'];

const CATEGORY_KEYWORDS = {
  medical: ['bleeding', 'blood', 'injury', 'hurt', 'pain', 'sick', 'fever', 'unconscious', 'heart attack', 'stroke', 'overdose', 'medical', 'hospital', 'doctor', 'medicine', 'broken bone', 'fracture', 'breathing'],
  food: ['hungry', 'food', 'water', 'thirsty', 'starving', 'drink', 'meal', 'eat', 'nutrition', 'supplies'],
  shelter: ['cold', 'hot', 'weather', 'roof', 'homeless', 'shelter', 'house', 'building', 'protection', 'warmth'],
  trapped: ['trapped', 'stuck', 'locked', 'can\'t move', 'debris', 'collapsed', 'cave', 'elevator', 'basement', 'underground'],
  other: []
};

function analyzeRequest(message, age, phone, name) {
  const text = message.toLowerCase();
  
  // Check for spam
  const isSpam = SPAM_KEYWORDS.some(keyword => text.includes(keyword)) || 
                 text.length < 10 || 
                 /^(.)\1{4,}/.test(text); // Repeated characters
  
  if (isSpam) {
    return {
      priority: 'spam',
      category: 'other',
      score: 0,
      reasoning: 'Flagged by AI: Potential spam or test message detected'
    };
  }

  // Factor 1: Severity (S) - Weight: 0.35
  let severityScore = 0.1;
  let severityReason = '';
  for (const [level, keywords] of Object.entries(SEVERITY_KEYWORDS)) {
    const matches = keywords.filter(keyword => text.includes(keyword));
    if (matches.length > 0) {
      if (level === 'high') {
        severityScore = 1;
        severityReason = `severe symptoms (${matches.slice(0,2).join(', ')})`;
      } else if (level === 'medium' && severityScore < 0.5) {
        severityScore = 0.5;
        severityReason = `moderate symptoms (${matches.slice(0,2).join(', ')})`;
      } else if (level === 'low' && severityScore < 0.2) {
        severityScore = 0.1;
        severityReason = 'minor symptoms';
      }
      break;
    }
  }

  // Factor 2: Immediacy (T) - Weight: 0.25
  let immediacyScore = 0.1;
  let immediacyReason = '';
  for (const [level, keywords] of Object.entries(IMMEDIACY_KEYWORDS)) {
    const matches = keywords.filter(keyword => text.includes(keyword));
    if (matches.length > 0) {
      if (level === 'critical') {
        immediacyScore = 1;
        immediacyReason = 'immediate action needed';
      } else if (level === 'moderate' && immediacyScore < 0.5) {
        immediacyScore = 0.5;
        immediacyReason = 'timely response needed';
      } else if (level === 'low' && immediacyScore < 0.2) {
        immediacyScore = 0.1;
        immediacyReason = 'non-urgent';
      }
      break;
    }
  }

  // Factor 3: Vulnerability (V) - Weight: 0.15
  let vulnerabilityScore = 0.5; // Default adult
  let vulnerabilityReason = '';
  
  // Age-based vulnerability
  if (age) {
    const ageNum = parseInt(age);
    if (ageNum <= 12) {
      vulnerabilityScore = 1;
      vulnerabilityReason = `child (age ${age})`;
    } else if (ageNum >= 65) {
      vulnerabilityScore = 1;
      vulnerabilityReason = `elderly (age ${age})`;
    } else {
      vulnerabilityScore = 0.5;
      vulnerabilityReason = `adult (age ${age})`;
    }
  }

  // Keyword-based vulnerability
  for (const [level, keywords] of Object.entries(VULNERABILITY_KEYWORDS)) {
    const matches = keywords.filter(keyword => text.includes(keyword));
    if (matches.length > 0) {
      if (level === 'high') {
        vulnerabilityScore = Math.max(vulnerabilityScore, 1);
        vulnerabilityReason = vulnerabilityReason ? `${vulnerabilityReason}, vulnerable person` : 'vulnerable person';
      }
      break;
    }
  }

  // Factor 4: Credibility (C) - Weight: 0.15
  let credibilityScore = 1; // Default high confidence
  let credibilityReason = 'verified contact info';
  
  if (!phone || phone.length !== 10) {
    credibilityScore = 0.5;
    credibilityReason = 'incomplete contact info';
  }
  if (!name || name.length < 2) {
    credibilityScore = Math.min(credibilityScore, 0.5);
    credibilityReason = 'incomplete personal info';
  }

  // Factor 5: Escalation History (E) - Weight: 0.10
  let escalationScore = 0.5; // Default first-time
  let escalationReason = 'first-time request';
  
  // Check for duplicate/similar requests
  const similarRequests = sosRequests.filter(r => 
    r.phone === phone || 
    (r.name.toLowerCase() === name.toLowerCase() && Math.abs(new Date(r.createdAt) - new Date()) < 3600000)
  );
  
  if (similarRequests.length > 0) {
    const unresolvedCount = similarRequests.filter(r => !r.resolved).length;
    if (unresolvedCount > 0) {
      escalationScore = 1;
      escalationReason = `${unresolvedCount} unresolved request(s)`;
    } else {
      escalationScore = 0.1;
      escalationReason = 'previously resolved';
    }
  }

  // Calculate weighted priority score
  const priorityScore = 
    0.35 * severityScore + 
    0.25 * immediacyScore + 
    0.15 * vulnerabilityScore + 
    0.15 * credibilityScore + 
    0.10 * escalationScore;

  // Map score to priority level
  let priority, priorityLabel;
  if (priorityScore >= 0.8) {
    priority = 'critical';
    priorityLabel = 'Critical';
  } else if (priorityScore >= 0.6) {
    priority = 'high';
    priorityLabel = 'High';
  } else if (priorityScore >= 0.4) {
    priority = 'medium';
    priorityLabel = 'Medium';
  } else if (priorityScore >= 0.2) {
    priority = 'low';
    priorityLabel = 'Low';
  } else {
    priority = 'minimal';
    priorityLabel = 'Minimal';
  }

  // Determine category
  let category = 'other';
  let maxMatches = 0;
  for (const [cat, keywords] of Object.entries(CATEGORY_KEYWORDS)) {
    if (cat === 'other') continue;
    const matches = keywords.filter(keyword => text.includes(keyword)).length;
    if (matches > maxMatches) {
      maxMatches = matches;
      category = cat;
    }
  }

  // Generate reasoning
  const reasoningParts = [];
  if (severityReason) reasoningParts.push(severityReason);
  if (vulnerabilityReason) reasoningParts.push(vulnerabilityReason);
  if (immediacyReason) reasoningParts.push(immediacyReason);
  if (escalationReason && escalationScore !== 0.5) reasoningParts.push(escalationReason);
  if (credibilityScore < 1) reasoningParts.push(credibilityReason);

  const reasoning = `${priorityLabel} Priority because: ${reasoningParts.join(', ')}.`;

  return {
    priority,
    category,
    score: Math.round(priorityScore * 100) / 100,
    reasoning
  };
}

function getCategoryIcon(category) {
  const icons = {
    medical: 'üè•',
    food: 'üçû',
    shelter: 'üè†',
    trapped: 'üöß',
    other: '‚ùì'
  };
  return icons[category] || '‚ùì';
}

function getPriorityIcon(priority) {
  const icons = {
    critical: 'üî¥',
    high: 'üü†',
    medium: 'üü°',
    low: 'üü¢',
    minimal: 'üîµ',
    spam: 'üö´'
  };
  return icons[priority] || 'üü¢';
}

/* =======  CONNECTIVITY MANAGEMENT  ======= */
let isOnline = navigator.onLine;
let syncInProgress = false;
let syncInterval;
let lastKnownCount = sosRequests.length;

function updateConnectionStatus() {
  const statusEl = document.getElementById('connectionStatus');
  const queueStatusEl = document.getElementById('queueStatus');
  
  if (syncInProgress) {
    statusEl.className = 'connection-status syncing';
    statusEl.textContent = 'üîÑ Syncing...';
  } else if (isOnline) {
    statusEl.className = 'connection-status online';
    statusEl.textContent = 'üü¢ Online';
    queueStatusEl.style.display = 'none';
  } else {
    statusEl.className = 'connection-status offline';
    statusEl.textContent = 'üî¥ Offline';
    if (requestQueue.length > 0) {
      queueStatusEl.style.display = 'block';
    }
  }
}

/* =======  REAL-TIME SYNC ACROSS DEVICES  ======= */
function startRealTimeSync() {
  // Check for updates every 2 seconds
  syncInterval = setInterval(async () => {
    if (!isOnline) return;
    
    try {
      // Simulate server sync by using a shared timestamp approach
      const currentTime = Date.now();
      const syncKey = 'sos.global.sync.' + Math.floor(currentTime / 2000); // 2-second windows
      
      // Check if there are new requests from other devices
      const globalRequests = JSON.parse(localStorage.getItem('sos.global.requests') || '[]');
      const localRequests = load();
      
      // Merge requests from other devices
      let hasNewRequests = false;
      globalRequests.forEach(globalReq => {
        const exists = localRequests.find(localReq => localReq.id === globalReq.id);
        if (!exists) {
          localRequests.unshift(globalReq);
          hasNewRequests = true;
        } else {
          // Update existing request if it was modified
          const localIndex = localRequests.findIndex(r => r.id === globalReq.id);
          if (localIndex !== -1 && globalReq.lastModified > (localRequests[localIndex].lastModified || 0)) {
            localRequests[localIndex] = globalReq;
            hasNewRequests = true;
          }
        }
      });
      
      if (hasNewRequests) {
        sosRequests = localRequests;
        save(sosRequests);
        
        // Update UI if on rescuer portal
        if (!document.getElementById('rescuer').hidden) {
          renderLists();
          showSyncNotification('üîÑ New requests synced from other devices');
        }
      }
      
      // Broadcast our requests to other devices
      localStorage.setItem('sos.global.requests', JSON.stringify(localRequests));
      
    } catch (error) {
      console.warn('Sync error:', error);
    }
  }, 2000);
}

function stopRealTimeSync() {
  if (syncInterval) {
    clearInterval(syncInterval);
    syncInterval = null;
  }
}

function showSyncNotification(message) {
  // Create temporary notification
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 70px;
    right: 20px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    animation: slideIn 0.3s ease-out;
  `;
  notification.textContent = message;
  
  // Add slide-in animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(notification);
  
  // Remove after 3 seconds
  setTimeout(() => {
    notification.style.animation = 'slideIn 0.3s ease-out reverse';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

async function syncQueue() {
  if (syncInProgress || requestQueue.length === 0 || !isOnline) return;
  
  syncInProgress = true;
  updateConnectionStatus();
  
  try {
    const processed = [];
    for (const queuedRequest of requestQueue) {
      sosRequests.unshift(queuedRequest);
      processed.push(queuedRequest);
    }
    
    if (processed.length > 0) {
      save(sosRequests);
      requestQueue = [];
      saveQueue(requestQueue);
      lastSyncTime = Date.now().toString();
      localStorage.setItem(SYNC_KEY, lastSyncTime);
      
      alert(`‚úÖ ${processed.length} queued request${processed.length > 1 ? 's' : ''} synced successfully!`);
      
      // Simulate real-time sync notification
      broadcastSync();
    }
  } catch (error) {
    console.error('Sync failed:', error);
  } finally {
    syncInProgress = false;
    updateConnectionStatus();
  }
}

function broadcastSync() {
  // Enhanced real-time sync across devices
  localStorage.setItem(SYNC_KEY, Date.now().toString());
  localStorage.setItem('sos.global.requests', JSON.stringify(sosRequests));
  window.dispatchEvent(new StorageEvent('storage', {
    key: KEY,
    newValue: JSON.stringify(sosRequests)
  }));
}

// Listen for real-time updates from other devices
window.addEventListener('storage', (e) => {
  if (e.key === KEY && e.newValue) {
    sosRequests = JSON.parse(e.newValue);
    if (document.getElementById('rescuer').hidden === false) {
      renderLists();
      showSyncNotification('üîÑ Real-time update received');
    }
  }
  
  // Listen for global sync updates
  if (e.key === 'sos.global.requests' && e.newValue) {
    const globalRequests = JSON.parse(e.newValue);
    const currentCount = sosRequests.length;
    const newCount = globalRequests.length;
    
    if (newCount > currentCount) {
      sosRequests = globalRequests;
      save(sosRequests);
      if (!document.getElementById('rescuer').hidden) {
        renderLists();
        showSyncNotification(`üö® ${newCount - currentCount} new SOS request(s) received!`);
      }
    }
  }
});

// Connection event listeners
window.addEventListener('online', () => {
  isOnline = true;
  updateConnectionStatus();
  syncQueue();
});

window.addEventListener('offline', () => {
  isOnline = false;
  updateConnectionStatus();
});

// Start real-time sync when page loads
startRealTimeSync();

// Stop sync when page unloads to prevent memory leaks
window.addEventListener('beforeunload', stopRealTimeSync);

updateConnectionStatus();

/* =======  TAB SWITCHING  ======= */
document.querySelectorAll('button.tab').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('button.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    document.getElementById('victim').hidden = tab!=='victim';
    document.getElementById('rescuer').hidden = tab!=='rescuer';
    if(tab==='rescuer') renderLists();
  });
});

/* =======  GEOLOCATION  ======= */
async function detectLocation(){
  const status = document.getElementById('locStatus');
  status.textContent='Detecting location‚Ä¶';

  if(!('geolocation' in navigator)){
    status.textContent='Geolocation not supported on this device.';
    return;
  }

  const opts={enableHighAccuracy:true,timeout:8000,maximumAge:15000};
  navigator.geolocation.getCurrentPosition(
    pos=>{
      const {latitude:lat,longitude:lon,accuracy} = pos.coords;
      document.getElementById('coords').value=`${lat.toFixed(6)}, ${lon.toFixed(6)}`;
      const link=`https://maps.google.com/?q=${lat},${lon}`;
      status.innerHTML=`Location set (¬±${Math.round(accuracy)} m). <a class="maplink" href="${link}" target="_blank" rel="noopener">Open map ‚Üó</a>`;
    },
    err=>{
      status.textContent='Could not detect location. Please allow permission and try again.';
      console.warn(err);
    },
    opts
  );
}
document.getElementById('detectBtn').addEventListener('click',detectLocation);

/* =======  FORM HANDLING  ======= */
document.getElementById('clearForm').addEventListener('click',()=>{
  document.getElementById('sosForm').reset();
  document.getElementById('locStatus').textContent='';
});

// Age input validation
document.getElementById('age').addEventListener('input', (e) => {
  const value = e.target.value;
  if (value && (isNaN(value) || parseInt(value) < 1 || parseInt(value) > 120)) {
    e.target.setCustomValidity('Please enter a valid age (1-120)');
  } else {
    e.target.setCustomValidity('');
  }
});

document.getElementById('sosForm').addEventListener('submit',e=>{
  e.preventDefault();
  const name=document.getElementById('name').value.trim();
  const age=document.getElementById('age').value.trim();
  const phone=document.getElementById('phone').value.trim();
  const message=document.getElementById('message').value.trim();
  const coords=document.getElementById('coords').value.trim();

  if(!/^\d{10}$/.test(phone)){
    alert('Phone number must be exactly 10 digits.');return;
  }
  if(!age || isNaN(age) || parseInt(age) < 1 || parseInt(age) > 120){
    alert('Please enter a valid age (1-120).');return;
  }
  if(!coords){
    alert('Please detect your location first.');return;
  }

  // AI Analysis
  const analysis = analyzeRequest(message, age, phone, name);

  const sos={
    id:Date.now(),
    name,age:parseInt(age),phone,message,coords,
    createdAt:new Date().toISOString(),
    lastModified:Date.now(),
    resolved:false,resolvedAt:null,
    priority: analysis.priority,
    category: analysis.category,
    priorityScore: analysis.score,
    reasoning: analysis.reasoning
  };

  if (isOnline && analysis.priority !== 'spam') {
    sosRequests.unshift(sos);
    save(sosRequests);
    broadcastSync();
    showSyncNotification('üö® SOS sent and synced to all rescuer devices!');
    alert('üö® SOS submitted successfully!');
  } else if (analysis.priority === 'spam') {
    sosRequests.unshift(sos);
    save(sosRequests);
    broadcastSync();
    alert('‚ö†Ô∏è Request submitted but flagged by AI for review.');
  } else {
    requestQueue.push(sos);
    saveQueue(requestQueue);
    alert('üì° SOS queued! Will be sent when connection returns.');
    updateConnectionStatus();
  }

  e.target.reset();
  document.getElementById('locStatus').textContent='';
});

/* =======  RESCUER  ======= */
function renderLists(){
  const q=document.getElementById('search').value.toLowerCase();
  const categoryFilter = document.getElementById('categoryFilter').value;
  const priorityFilter = document.getElementById('priorityFilter').value;
  const spamFilter = document.getElementById('spamFilter').value;
  
  const filtered=sosRequests.filter(r=>{
    const hay=`${r.name} ${r.coords} ${r.message}`.toLowerCase();
    const matchesSearch = hay.includes(q);
    const matchesCategory = !categoryFilter || r.category === categoryFilter;
    const matchesPriority = !priorityFilter || r.priority === priorityFilter;
    
    let matchesSpam = true;
    if (spamFilter === 'hide' && r.priority === 'spam') matchesSpam = false;
    if (spamFilter === 'only' && r.priority !== 'spam') matchesSpam = false;
    
    return matchesSearch && matchesCategory && matchesPriority && matchesSpam;
  });

  // Sort pending by priority score (higher first)
  const pending = filtered.filter(r=>!r.resolved)
    .sort((a, b) => (b.priorityScore || 0) - (a.priorityScore || 0));
  const resolved = filtered.filter(r=>r.resolved);

  // KPIs
  const criticalCount = sosRequests.filter(r => !r.resolved && r.priority === 'critical').length;
  document.getElementById('kpiTotal').textContent=sosRequests.filter(r => r.priority !== 'spam').length;
  document.getElementById('kpiPending').textContent=pending.length;
  document.getElementById('kpiResolved').textContent=resolved.length;
  document.getElementById('kpiCritical').textContent=criticalCount;

  paintList('pendingList',pending,false);
  paintList('resolvedList',resolved,true);
}

function paintList(id,arr,isResolved){
  const host=document.getElementById(id);
  host.innerHTML='';
  if(!arr.length){
    host.innerHTML=`<div class="empty">${isResolved?'No resolved requests yet.':'No pending requests.'}</div>`;
    return;
  }
  arr.forEach(r=>{
    const div=document.createElement('div');
    div.className = `item ${r.priority || 'low'}`;
    
    const when=new Date(r.createdAt).toLocaleString();
    const map=r.coords?`<a class="maplink" href="https://maps.google.com/?q=${encodeURIComponent(r.coords)}" target="_blank" rel="noopener">Map ‚Üó</a>`:'';
    const priorityIcon = getPriorityIcon(r.priority || 'low');
    const categoryIcon = getCategoryIcon(r.category || 'other');

    div.innerHTML=`
      <div class="priority-indicator ${r.priority || 'low'}"></div>
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:8px">
        <strong>${escapeHtml(r.name)} (${r.age || 'N/A'})</strong>
        <span class="badge ${isResolved?'ok':'pending'}">${isResolved?'Resolved ‚úÖ':'Pending ‚è≥'}</span>
      </div>
      <div class="meta">
        <span class="badge ${r.priority || 'low'}">${priorityIcon} ${(r.priority || 'low').toUpperCase()}</span>
        <span class="badge ${r.category || 'other'}">${categoryIcon} ${(r.category || 'other').toUpperCase()}</span>
        <span class="badge">${when}</span>
        <span class="badge">${escapeHtml(r.coords)}</span>
        ${map}
      </div>
      ${r.reasoning ? `<div class="ai-reasoning"><strong>ü§ñ AI Analysis:</strong> ${escapeHtml(r.reasoning)}</div>` : ''}
      <p style="margin:10px 0">${escapeHtml(r.message)}</p>
      <div class="muted">üìû ${escapeHtml(r.phone)}</div>
      <div class="actions" style="margin-top:8px">
        ${isResolved
          ?`<button class="btn warn" onclick="markUnresolved(${r.id})">Mark Unresolved</button>`
          :`<button class="btn ok" onclick="markResolved(${r.id})">Mark Resolved</button>`}
        <button class="btn" onclick="removeReq(${r.id})">Delete</button>
      </div>`;
    host.appendChild(div);
  });
}

function escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}

function markResolved(id){
  sosRequests=sosRequests.map(r=>r.id===id?{...r,resolved:true,resolvedAt:new Date().toISOString()}:r);
  save(sosRequests);
  broadcastSync();
  renderLists();
}

function markUnresolved(id){
  sosRequests=sosRequests.map(r=>r.id===id?{...r,resolved:false,resolvedAt:null}:r);
  save(sosRequests);
  broadcastSync();
  renderLists();
}

function removeReq(id){
  if(confirm('Delete this request?')){
    sosRequests=sosRequests.filter(r=>r.id!==id);
    save(sosRequests);
    broadcastSync();
    renderLists();
  }
}

function clearAllRequests(){
  if(confirm('‚ö†Ô∏è This will permanently delete ALL SOS requests (pending and resolved). This action cannot be undone.\n\nAre you sure you want to continue?')){
    sosRequests = [];
    requestQueue = [];
    save(sosRequests);
    saveQueue(requestQueue);
    broadcastSync();
    renderLists();
    alert('‚úÖ All requests cleared successfully.');
  }
}

// Event listeners for filters and controls
document.getElementById('search').addEventListener('input',renderLists);
document.getElementById('categoryFilter').addEventListener('change',renderLists);
document.getElementById('priorityFilter').addEventListener('change',renderLists);
document.getElementById('spamFilter').addEventListener('change',renderLists);
document.getElementById('resetSearch').addEventListener('click',()=>{
  document.getElementById('search').value='';
  document.getElementById('categoryFilter').value='';
  document.getElementById('priorityFilter').value='';
  document.getElementById('spamFilter').value='hide';
  renderLists();
});
document.getElementById('clearAll').addEventListener('click',clearAllRequests);

// Periodic sync check (every 5 seconds)
setInterval(() => {
  if (isOnline && requestQueue.length > 0) {
    syncQueue();
  }
  
  // Enhanced periodic sync for real-time updates
  if (isOnline) {
    const globalRequests = JSON.parse(localStorage.getItem('sos.global.requests') || '[]');
    if (globalRequests.length !== sosRequests.length) {
      sosRequests = globalRequests;
      save(sosRequests);
      if (!document.getElementById('rescuer').hidden) {
        renderLists();
      }
    }
  }
}, 5000);
</script>
</body>
</html>
